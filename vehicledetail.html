<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Details | Alfa Motors World</title>
    <link rel="stylesheet" href="./global.css" />
    <link rel="stylesheet" href="./style.css" />

    <link rel="stylesheet" href="./vehicledetail.css" />
    <link rel="stylesheet" href="./inventory.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="hero-section">
      <nav class="navbar">
        <button class="mobile-menu-toggle" aria-label="Open menu">
          <i class="fas fa-bars"></i>
        </button>
        <a href="index.html" class="logo-link">
          <div class="logo">
            <img
              src="./assets/logo2.svg"
              class="logo-img"
              alt="Alfa Motors World Logo"
              itemprop="logo"
            />
          </div>
        </a>
        <ul class="nav-links">
          <li><a href="index.html" data-translate="Home">Home</a></li>
          <li>
            <a href="inventory.html" class="active" data-translate="Buy Car"
              >Buy Car</a
            >
          </li>
          <li>
            <a href="sell.html" data-translate="Sell Your Car">Sell Your Car</a>
          </li>
          <li><a href="about.html" data-translate="About Us">About Us</a></li>
          <li><a href="#" data-translate="Updates">Updates</a></li>
          <li><a href="contact.html" data-translate="Contact">Contact</a></li>
        </ul>
        <div class="login-btn">
          <a href="/getquote.html">
            <button data-translate="Get the Quote">Get the Quote</button>
          </a>
        </div>
      </nav>
      <div class="vehicle-main-section">
        <div class="vehicle-image-block">
          <img
            id="mainVehicleImg"
            class="vehicle-main-img"
            src="assets/owner.png"
            alt="Car"
          />
          <div class="vehicle-thumbnails" id="vehicleThumbnails"></div>
        </div>
        <div class="vehicle-details-block">
          <div class="vehicle-title" id="vehicleTitle">Car Brand Model</div>
          <div class="vehicle-model" id="vehicleModel">2022 Model</div>
          <div class="vehicle-details-grid">
            <div class="vehicle-detail-item">
              <i class="fas fa-tachometer-alt"></i>
              <span style="font-weight: bold">Vehicle Driven</span>
              <span style="margin-left: 10px" id="vehicleKm">0 km</span>
            </div>
            <div class="vehicle-detail-item">
              <i class="fas fa-user"></i>
              <span style="font-weight: bold">Ownership</span>
              <span style="margin-left: 10px" id="vehicleOwner">1st Owner</span>
            </div>
            <div class="vehicle-detail-item">
              <i class="fas fa-gas-pump"></i>
              <span style="font-weight: bold">Fuel Type</span>
              <span style="margin-left: 10px" id="vehicleFuel">Petrol</span>
            </div>
            <div class="vehicle-detail-item">
              <i class="fas fa-palette"></i>
              <span style="font-weight: bold">Vehicle Color</span>
              <span style="margin-left: 10px" id="vehicleColor">Color</span>
            </div>

            <div class="vehicle-detail-item">
              <i class="fas fa-id-card"></i>
              <span style="font-weight: bold">Reg Year</span>
              <span style="margin-left: 10px" id="vehicleRegYear"
                >Reg Year</span
              >
            </div>
          </div>
          <div class="vehicle-price" id="vehiclePrice">₹0</div>
          <div class="vehicle-emi" id="vehicleEmi">
            Down: ₹0 | EMI: ₹0/month
          </div>
          <button
            class="add-to-cart-btn"
            onclick="window.location.href='contact.html'"
          >
            Contact Seller
          </button>
        </div>
      </div>
      <div class="why-choose-row">
        <div class="why-choose-item">
          <i class="fas fa-shield-alt"></i> Verified Documents
        </div>
        <div class="why-choose-item">
          <i class="fas fa-car"></i> Quality Checked
        </div>
        <div class="why-choose-item">
          <i class="fas fa-star"></i> Great Value
        </div>
        <div class="why-choose-item">
          <i class="fas fa-heart"></i> Trusted Seller
        </div>
      </div>
      <div class="other-cars-section">
        <h2 class="other-cars-title">Other Cars You May Like</h2>
        <div class="other-cars-row" id="otherCarsRow"></div>
      </div>
    </div>
    <div id="mobileMenu" class="mobile-menu" aria-hidden="true"></div>
    <script>
      // Mobile Menu Functionality
      (function () {
        const mobileMenu = document.getElementById("mobileMenu");
        const toggle = document.querySelector(".mobile-menu-toggle");

        function buildMenu() {
          if (!mobileMenu) return;
          mobileMenu.innerHTML = `
            <button class="close-btn" aria-label="Close menu">&times;</button>
            <nav class="mobile-nav">
              <a href="index.html">Home</a>
              <a href="inventory.html">Buy Car</a>
              <a href="sell.html">Sell Your Car</a>
              <a href="about.html">About Us</a>
              <a href="contact.html">Contact</a>
              <a href="getquote.html">Get the Quote</a>
            </nav>
          `;
          const close = mobileMenu.querySelector(".close-btn");
          if (close)
            close.addEventListener("click", () =>
              mobileMenu.classList.remove("active")
            );
        }

        function openMenu() {
          buildMenu();
          mobileMenu.classList.add("active");
          mobileMenu.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
        }

        function closeMenu() {
          mobileMenu.classList.remove("active");
          mobileMenu.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
        }

        if (toggle) toggle.addEventListener("click", openMenu);
        mobileMenu.addEventListener("click", (e) => {
          if (e.target === mobileMenu) closeMenu();
        });
      })();

      // Helper Functions
      function formatOwnership(owner) {
        if (owner === "1" || owner.includes("1st")) return "1st Owner";
        if (owner === "2" || owner.includes("2nd")) return "2nd Owner";
        if (owner === "3" || owner.includes("3+") || owner.includes("3rd"))
          return "3+ Owner";
        return owner;
      }

      function normalizeImagePath(img) {
        let filename = img;
        if (filename.startsWith("carimages/"))
          filename = filename.replace("carimages/", "");
        if (filename.startsWith("assets/")) return filename;
        return `https://alfa-motors-5yfh.vercel.app/carimages/${filename}`;
      }

      function getCarDataFromQuery() {
        const params = new URLSearchParams(window.location.search);
        try {
          return JSON.parse(decodeURIComponent(params.get("car")));
        } catch {
          return null;
        }
      }

      function carIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        try {
          const car = JSON.parse(decodeURIComponent(params.get("car")));
          return car && car._id ? car._id : null;
        } catch {
          return null;
        }
      }

      // Load Car Data
      const car = getCarDataFromQuery();
      if (car) {
        // Populate car details
        document.getElementById("vehicleTitle").textContent = `${
          car.brand || car.make || ""
        } ${car.model || ""}`;
        document.getElementById("vehicleModel").textContent = `${
          car.modelYear || ""
        } Model`;
        document.getElementById("vehicleKm").textContent = `${(
          car.kmDriven || 0
        ).toLocaleString()} km`;
        document.getElementById("vehicleOwner").textContent = formatOwnership(
          car.ownership || "1"
        );
        document.getElementById("vehicleFuel").textContent =
          car.fuelType || "Petrol";
        document.getElementById("vehicleColor").textContent = car.color || "";
        document.getElementById("vehicleRegYear").textContent =
          car.registrationYear || "";
        document.getElementById("vehiclePrice").textContent = `₹${(
          car.sellingPrice ||
          car.price ||
          0
        ).toLocaleString()}`;
        document.getElementById("vehicleEmi").textContent = `Down: ₹${(
          car.downPayment || 0
        ).toLocaleString()} | EMI: ₹${Math.round(
          ((car.sellingPrice || car.price || 0) - (car.downPayment || 0)) / 36
        ).toLocaleString()}/month`;

        // Handle images
        const images =
          car.photos && car.photos.length > 0
            ? car.photos
            : ["assets/owner.png"];
        const mainImg = document.getElementById("mainVehicleImg");
        const thumbnails = document.getElementById("vehicleThumbnails");
        thumbnails.innerHTML = "";

        // Mobile Image Layout
        if (window.innerWidth <= 900) {
          const container = document.createElement("div");
          container.className = "vehicle-image-block mobile-image-block";

          // Main image
          const mainImgMobile = document.createElement("img");
          mainImgMobile.className = "vehicle-main-img mobile-main-img";
          mainImgMobile.src = normalizeImagePath(images[0]);
          mainImgMobile.alt = "Main Car Image";
          container.appendChild(mainImgMobile);

          // Thumbnails row
          const thumbRow = document.createElement("div");
          thumbRow.className = "vehicle-thumbnails mobile-thumbnails";

          images.forEach((img, idx) => {
            const thumb = document.createElement("img");
            thumb.src = normalizeImagePath(img);
            thumb.alt = `Car ${idx + 1}`;
            thumb.style.border =
              idx === 0 ? "2px solid #ff6b00" : "2px solid transparent";
            thumb.onclick = () => {
              mainImgMobile.src = normalizeImagePath(img);
              Array.from(thumbRow.children).forEach((t, i) => {
                t.style.border =
                  i === idx ? "2px solid #ff6b00" : "2px solid transparent";
              });
            };
            thumbRow.appendChild(thumb);
          });

          container.appendChild(thumbRow);
          mainImg.parentNode.replaceChild(container, mainImg);
        } else {
          // Desktop Image Layout
          images.forEach((img, idx) => {
            const thumb = document.createElement("img");
            thumb.src = normalizeImagePath(img);
            thumb.alt = `Car ${idx + 1}`;
            thumb.onclick = () => {
              mainImg.src = normalizeImagePath(img);
              Array.from(thumbnails.children).forEach((t) =>
                t.classList.remove("selected")
              );
              thumb.classList.add("selected");
            };
            if (idx === 0) thumb.classList.add("selected");
            thumbnails.appendChild(thumb);
          });
          mainImg.src = normalizeImagePath(images[0]);
        }
      }

      // Load Other Cars
      fetch("https://alfa-motors-5yfh.vercel.app/api/cars")
        .then((response) => response.json())
        .then((data) => {
          if (data.success && Array.isArray(data.data)) {
            const cars = data.data;
            const otherCarsRow = document.getElementById("otherCarsRow");
            otherCarsRow.innerHTML = "";

            cars.forEach((car) => {
              if (car._id && car._id === (carIdFromQuery() || "")) return;

              const imgSrc =
                car.photos && car.photos.length > 0
                  ? car.photos[0].startsWith("assets/")
                    ? car.photos[0]
                    : `https://alfa-motors-5yfh.vercel.app/carimages/${car.photos[0]}`
                  : "assets/owner.png";

              const statusClass =
                car.status === "Available"
                  ? "status-available"
                  : car.status === "Sold Out"
                  ? "status-sold"
                  : car.status === "Coming Soon"
                  ? "status-coming-soon"
                  : "status-available";

              const ownerText = formatOwnership(car.ownership || "1");

              const card = document.createElement("div");
              card.className = "other-car-card";
              card.innerHTML = `
                <div class="image-container">
                  <img src="${imgSrc}" alt="${car.brand || car.make || ""} ${
                car.model || ""
              }" class="other-car-img" />
                  <div class="status-badge ${statusClass}">${
                car.status || "Available"
              }</div>
                </div>
                <div class="card-content">
                  <h3>${car.brand || car.make || "Unknown Brand"} ${
                car.model || "Unknown Model"
              }</h3>
                  <span class="model">${car.modelYear || "-"} Model</span>
                  <div class="details">
                    <div class="detail-item"><i class="fas fa-tachometer-alt"></i> <span>${(
                      car.kmDriven || 0
                    ).toLocaleString()} km</span></div>
                    <div class="detail-item"><i class="fas fa-user"></i> <span>${ownerText}</span></div>
                    <div class="detail-item"><i class="fas fa-gas-pump"></i> <span>${
                      car.fuelType || "Petrol"
                    }</span></div>
                  </div>
                  <div class="price-container">
                    <div class="price">₹${(
                      car.sellingPrice ||
                      car.price ||
                      0
                    ).toLocaleString()}</div>
                    <div class="button-group">
                      <button class="contact-btn" ${
                        car.status !== "Available" ? "disabled" : ""
                      }>Contact Seller</button>
                      <button class="view-details-btn" ${
                        car.status !== "Available" ? "disabled" : ""
                      }>View Details</button>
                    </div>
                  </div>
                </div>
              `;

              // Add event listeners
              setTimeout(() => {
                const viewDetailsBtn = card.querySelector(".view-details-btn");
                const contactBtn = card.querySelector(".contact-btn");

                if (viewDetailsBtn && !viewDetailsBtn.disabled) {
                  viewDetailsBtn.onclick = (e) => {
                    e.stopPropagation();
                    const carQuery = encodeURIComponent(JSON.stringify(car));
                    window.location.href = `vehicledetail.html?car=${carQuery}`;
                  };
                }

                if (contactBtn && !contactBtn.disabled) {
                  contactBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.location.href = "contact.html";
                  };
                }
              }, 0);

              otherCarsRow.appendChild(card);
            });

            // Enable auto-scroll for other cars
            enableAutoSlider();
          }
        });

      // Auto-scroll functionality
      function enableAutoSlider() {
        const row = document.getElementById("otherCarsRow");
        if (!row) return;

        let scrollAmount = 0;
        let maxScroll = row.scrollWidth - row.clientWidth;
        let direction = 1;

        let interval = setInterval(() => {
          if (row.scrollWidth <= row.clientWidth) return;

          if (scrollAmount >= maxScroll) direction = -1;
          if (scrollAmount <= 0) direction = 1;

          scrollAmount += direction * 320;
          if (scrollAmount < 0) scrollAmount = 0;
          if (scrollAmount > maxScroll) scrollAmount = maxScroll;

          row.scrollTo({ left: scrollAmount, behavior: "smooth" });
        }, 3000);

        row.addEventListener("mouseenter", () => clearInterval(interval));
        row.addEventListener("mouseleave", () => {
          interval = setInterval(() => {
            if (row.scrollWidth <= row.clientWidth) return;

            if (scrollAmount >= maxScroll) direction = -1;
            if (scrollAmount <= 0) direction = 1;

            scrollAmount += direction * 320;
            if (scrollAmount < 0) scrollAmount = 0;
            if (scrollAmount > maxScroll) scrollAmount = maxScroll;

            row.scrollTo({ left: scrollAmount, behavior: "smooth" });
          }, 3000);
        });
      }
    </script>
  </body>
</html>
